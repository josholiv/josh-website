---
import BaseLayout from '../layouts/BaseLayout.astro';
import { Image } from 'astro:assets';
import aboutMePhoto from '../assets/josh-headshot-cropped.jpg';
import ChessStats from '../components/chesscom.tsx';
import Strava from "../components/strava.js";
import TriathlonStats from '../components/TriathlonStats.jsx';
import Hardcover from '../components/Hardcover.js';
import HardcoverStats from '../components/HardcoverStats.jsx';
import ErrorRenderer from "../Error.astro";
import StravaContributionGrid from "../components/StravaContributionGrid.jsx";

const pageTitle = "Josh Olivier - About";

// Fetch Strava data
let data, dailyData, error;

try {
  const strava = new Strava();
  data = await strava.fetch(); // stats
  dailyData = await strava.fetchDailyActivityCounts(); // contributions
} catch (e) {
  error = e.message;
}

// Fetch Hardcover data
let hardcoverGoals = [];
let topGenresAllTime = [];
let booksThisYear = [];
let hardcoverError;

try {
  const hc = new Hardcover();
  const result = await hc.fetch(); // fetch goals, topGenres, and userBooks

  hardcoverGoals = result.goals;
  topGenresAllTime = result.topGenres; // top 5 genres of all time

  const allBooks = result.userBooks || [];
  
  // Books read in the current year
  const currentYear = new Date().getFullYear();
  booksThisYear = allBooks
    .filter(entry => entry.reviewed_at && new Date(entry.reviewed_at).getFullYear() === currentYear)
    .map(entry => ({
      title: entry.book?.title || "Untitled",
      rating: entry.rating ?? null
    }));

} catch (e) {
  hardcoverGoals = [];
  topGenresAllTime = [];
  booksThisYear = [];
  hardcoverError = e.message;
}
---

<BaseLayout pageTitle={pageTitle} shouldCenterTitle={false} shouldShowTitle={false}>

  <h1>About</h1>

    <Image
      src={aboutMePhoto}
      alt="Josh Olivier"
      class="about-pic"
      loading="eager"
      priority
    />

    <h2>Who I am</h2>

    <p>
      My name is Josh Olivier, and I'm a lab manager in a neuroimaging research lab in Dallas, Texas.
    </p>

    <p>
      I'm interested in researching how memory, brain structure, and brain function
      are related and how these relationships change with increasing age across the lifespan.
    </p>
    
    <p>
      In my free time, I love traveling, trying new foods, 
      and learning new skills. I learned Portuguese
      after spending some time living in Manaus, Brazil. There, I enjoyed eating lots of 
      açaí, tacacá, and grilled tambaqui. I visit Brazil often and try to explore a new region of 
      the country at least once each year.
      In addition to Portuguese, I'm currently working on learning Spanish.
    </p>

    <p>
      Some of my other hobbies include fiddling with my 3D printer, drinking tereré (cold yerba mate), and training for triathlons. 
      So far, in <strong>{new Date().getFullYear()}</strong>, I’ve logged the distances shown below for {" "}
        <span style={{fontWeight: 'bold', color: "var(--blue-400)"}}>swimming</span>,{" "}
        <span style={{fontWeight: 'bold', color: "var(--green-400)"}}>cycling</span>, and{" "}
        <span style={{fontWeight: 'bold', color: "var(--orange-400)"}}>running</span>, according to my data from Strava.
    </p>

  <h2 id="distances-logged">Distances logged in {new Date().getFullYear()}</h2>

	<TriathlonStats client:load data={data} error={error} />
	    <ErrorRenderer error={error} />
  
<!-- <StravaContributionGrid client:load dailyCounts={dailyData?.dailyCounts ?? {}} /> -->

      <p>

        I also love playing online chess, especially speed chess, where time controls are set so each player is allotted a limited amount of time to play their moves.
        Below are my current ratings on chess.com for three categories of speed chess: 

        <li>
          <span style={{fontWeight: 'bold', color: "var(--red-400)"}}>bullet</span>{" "} 
          (time controls of less than 3 minutes per player)
        </li>

        <li>
          <span style={{fontWeight: 'bold', color: "var(--pink-400)"}}>blitz</span>{" "} 
          (time controls of less than 10 minutes per player)
        </li>

        <li>
          <span style={{fontWeight: 'bold', color: "var(--purple-400)"}}>rapid</span>{" "}
          (time controls of more than 10 minutes per player)
        </li>

      </p>

  <h2 id="chess-stats">Chess stats</h2>

	<ChessStats client:load /> 

    <p>
      I also enjoy reading. According to my data from Hardcover, my top genres are{" "}
      {topGenresAllTime.length > 0
        ? topGenresAllTime
            .map(g => g.genre)
            .reduce((acc, genre, i, arr) => 
              i === 0 
                ? <strong>{genre}</strong> 
                : i === arr.length - 1 
                  ? <>{acc} and <strong>{genre}</strong></> 
                  : <>{acc}, <strong>{genre}</strong></>
            , "")
        : "not available yet"}
      . Below is the total number of <span style={{fontWeight: 'bold', color: "var(--neutral-050)"}}>books I've read 
        in {" "}{new Date().getFullYear()}</span> and my reading goal for the year.
    </p>
    
  <h2 id="books-read">Books read in {new Date().getFullYear()}</h2>

  <HardcoverStats client:only data={hardcoverGoals} />

  <ErrorRenderer error={hardcoverError} />
</BaseLayout>